package ui.view.view2.NewMap {		import common.config.xmlres.XmlManager;	import common.config.xmlres.server.Pub_MapResModel;	import common.managers.Lang;	import common.utils.CtrlFactory;		import engine.load.GamelibS;	import engine.support.IPacket;		import flash.display.DisplayObject;	import flash.display.MovieClip;	import flash.display.Sprite;		import netc.Data;	import netc.packets2.StructMapSeek2;	import netc.packets2.StructNpcTrans2;		import nets.packets.PacketCSGuildHelp;	import nets.packets.PacketCSMapSend;	import nets.packets.PacketCSNpcSend;	import nets.packets.PacketCSRoleChangeMap;	import nets.packets.PacketSCMapSend;	import nets.packets.PacketSCNpcSend;		import scene.utils.MapData;		import ui.frame.ImageUtils;	import ui.frame.UIWindow;		import world.FileManager;
		/**	 * 地图传送	 * @author suhang	 * @2011－10－28	 */	public class TransMap extends UIWindow{		public static const HUAN_JING_ID:int=80200003;		private var sprite : Sprite = new Sprite;		private var currData:Object=null;		private var list_id:int;				public function TransMap() : void {			super(getLink("win_chuan_song"));		}				private static var _instance:TransMap=null;				public static function instance():TransMap		{			if (_instance == null)			{				_instance=new TransMap();			}			return _instance;		}		public function setListId(listid:int):void{			this.list_id=listid;			super.open();		}				override protected function init() : void {			uiRegister(PacketSCNpcSend.id,SCNpcSend);			var vo:PacketCSNpcSend = new PacketCSNpcSend();			vo.list_id = list_id;			uiSend(vo);//			mc["sp"].position=0;						super.uiRegister(PacketSCMapSend.id,SCMapSend);					}		private function SCNpcSend(p:IPacket) : void {			var value:PacketSCNpcSend = p as PacketSCNpcSend;			while(sprite.numChildren>0){				sprite.removeChildAt(0);			}					value.arrItemlist.forEach(callBack);			if(sprite.getChildByName("item0")!=null){				itemSelected(sprite.getChildByName("item0"));				currData = (sprite.getChildByName("item0") as MovieClip).data;				}else{				currData = null;			}			mc["sp"].source = sprite;					}				private function callBack(valueObj:Object,index:int,arr:Vector.<StructNpcTrans2>):void{			var itemDO:MovieClip = GamelibS.getswflink("game_index", "item_chuan_song") as MovieClip;			var itemData:Pub_MapResModel = XmlManager.localres.getPubMapXml.getResPath(valueObj.map_id) as Pub_MapResModel;			if(itemData!=null){				super.itemEvent(itemDO,itemData,true);				//	if(itemData.min_level<=DataCenter.myKing.level){								//itemDO["uil"].source = FileManager.instance.getSendSmallMapById(itemData.map_id);				//				itemDO["uil"].source = FileManager.instance.getSendSmallMapById(itemData.res_id);				ImageUtils.replaceImage(itemDO,itemDO["uil"],FileManager.instance.getSendSmallMapById(itemData.res_id));								var color:String="";				if(Data.myKing.coin1<itemData.send_coin){					color="ff0000";				}else{					color="fff5d2";				}				itemDO["txt_fei_yong"].htmlText ="<font color='#"+color+"'>"+ itemData.send_coin+Lang.getLabel("pub_yin_liang")+"</font>";				if(Data.myKing.level<itemData.min_level){					color="ff0000";				}else{					color="fff5d2";				}				itemDO["txt_level1"].htmlText = "<font color='#"+color+"'>"+ itemData.min_level+Lang.getLabel("pub_ji")+"</font>";				itemDO["txt_level2"].htmlText = itemData.pk_mode;				itemDO["txt_level3"].htmlText = itemData.monster_level;								itemDO.name = "item"+index;				itemDO.data = {map_id:itemData.map_id,send_id:valueObj.send_id,min_level:itemData.min_level};				itemDO.y = (itemDO.height-43)*index;				itemDO.x = 5;				itemDO.mouseChildren = true;				sprite.addChild(itemDO);			}		}				// 鼠标点击事件		override public function mcHandler(target : Object) : void {			super.mcHandler(target);			if(target.parent.name.indexOf("item")==0){				currData = target.parent.data;				itemSelected(target.parent);			}			switch(target.name) {				case "btnChuanSong":					if(currData!=null){						if(currData.min_level<=Data.myKing.level){							chuanSongPoint(currData.send_id);							winClose();							}else{							Lang.showMsg(Lang.getClientMsg("20068_TransMap"));						}					}					break;			}		}				private function SCMapSend(p:IPacket) : void {			if(super.showResult(p)){						}else{						}		}						/**		 *	免费传送【传送点】		 *  andy 2012-09-21 		 *  @sendid 传送点 		 */		public function chuanSongPoint(sendid:int):void{			var vo:PacketCSMapSend = new PacketCSMapSend();			vo.sendid = sendid;			uiSend(vo);		}		/**		 *	免费传送		 *  andy 2012-09-21 		 *  @param mapId 		 *  @param mapX		 *  @param mapY		 */		public function chuanSongFree(mapId:int,mapX:int,mapY:int,seekId:int=0):void{			var client:PacketCSRoleChangeMap=new PacketCSRoleChangeMap();			client.mapid=mapId;			client.mapx=mapX;			client.mapy=mapY;			client.seekid=seekId;			super.uiSend(client);		}		/**		 *	 家族救援		 *  andy 2012-10-09		 *  @param mapId 		 *  @param mapX		 *  @param mapY		 */		public function jiaZuHelp(mapId:int,mapX:int,mapY:int):void{			var client:PacketCSGuildHelp=new PacketCSGuildHelp();			client.mapid=mapId;			client.mapx=mapX;			client.mapy=mapY;			super.uiSend(client);		}				// REMOVE==		// 窗口关闭事件		override protected function windowClose() : void {			super.windowClose();			while(sprite.numChildren>0){				sprite.removeChildAt(0);			}			return;		}			}}